kind: pipeline
type: docker
name: main

steps:
- name: validate repo
  image: node:16.18.1
  commands:
  - '[ "$(sha256sum get_repo_fingerprint.sh | cut -d " " -f 1)" = "64bb841c427967e702e0bf6060244e5f306d4b5fc070ff2fa2eea209451abbeb" ]'
  - '[ "$(./get_repo_fingerprint.sh | sha256sum | cut -d " " -f 1)" = "82a030bce5ba1e9068e345afd677bc1bcd9aad8ea9fd8474f708d0853efc4204" ]'

- name: test
  image: node:16.18.1
  commands:
  - useradd -ms /bin/sh hh && chown -R hh:hh .
  - su hh -c "cd $(pwd) && npm i"
  - su hh -c "cd $(pwd) && npx hardhat test"

- name: deploy
  image: node:16.18.1
  environment:
    BLOCKCHAIN_TOKEN:
      from_secret: BLOCKCHAIN_TOKEN
  when:
    branch:
    - master
  commands:
  - useradd -ms /bin/sh hh && chown -R hh:hh .
  - su hh -c "cd $(pwd) && npm i"
  - su hh -c "cd $(pwd) && npx hardhat run ./scripts/service_deploy.js --network ctfpuc_private"
